<!DOCTYPE html>
<html lang="or">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>A to Z Packers & Movers ‚Äî Attendance (Secure Auth)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px}
    .hidden{display:none}
    .btn{width:100%;padding:10px 14px;border-radius:10px;color:#fff;font-weight:700}
    .btn-blue{background:#2563eb}.btn-green{background:#16a34a}.btn-yellow{background:#d97706}
    .btn-brown{background:#854d0e}.btn-red{background:#dc2626}.btn-gray{background:#4b5563}
    .muted{color:#6b7280}
    .toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:100}
  </style>
</head>
<body class="bg-white text-gray-900 min-h-screen">

  <!-- Header -->
  <header class="px-5 py-4 bg-green-600 text-white">
    <h1 class="text-xl font-extrabold">A to Z Packers & Movers ‚Äî Staff Attendance</h1>
    <p class="text-sm opacity-90">Secure login ‚Ä¢ Cloud backup (Firestore) ‚Ä¢ IST time</p>
  </header>

  <!-- Auth Box -->
  <section id="authBox" class="p-5 max-w-xl mx-auto">
    <div class="card">
      <h3 class="text-xl font-bold mb-3">üîê ‡¨∏‡≠Å‡¨∞‡¨ï‡≠ç‡¨∑‡¨ø‡¨§ ‡¨≤‡¨ó‡¨ø‡¨®‡≠ç</h3>

      <!-- Staff Email/Password -->
      <div id="staffLogin" class="mb-3">
        <input id="email" type="email" placeholder="Staff Email" class="border rounded px-3 py-2 w-full mb-2"/>
        <input id="password" type="password" placeholder="Password" class="border rounded px-3 py-2 w-full mb-2"/>
        <button id="btnStaffLogin" class="btn btn-blue">Staff Login (Email/Password)</button>
      </div>

      <div class="text-center text-gray-500 my-2">‚Äî ‡¨Ö‡¨•‡¨¨‡¨æ ‚Äî</div>

      <!-- Boss Google -->
      <button id="btnBossGoogle" class="btn btn-green">Boss Google Sign-in</button>

      <button id="btnSignOut" class="mt-3 btn btn-gray hidden">Sign out</button>
      <div id="whoami" class="text-sm text-gray-600 mt-2"></div>
      <p id="envNote" class="muted text-sm mt-2"></p>
    </div>
  </section>

  <!-- App (Staff panel) -->
  <section id="app" class="hidden p-5 max-w-xl mx-auto">
    <div class="card">
      <h2 class="text-xl font-bold mb-4">üóìÔ∏è Attendance Panel</h2>
      <div class="space-y-3">
        <button id="btnCheckIn" class="btn btn-green">‚úÖ Check In</button>
        <button id="btnBreakStart" class="btn btn-yellow">‚òï Start Break</button>
        <button id="btnBreakEnd" class="btn btn-brown">üçΩÔ∏è End Break</button>
        <button id="btnCheckOut" class="btn btn-red">‚õî Check Out</button>
      </div>
      <div class="mt-6 space-y-3">
        <button id="btnHistory" class="btn btn-blue">üìú ‡¨Ü‡¨ú‡¨ø‡¨∞ ‡¨á‡¨§‡¨ø‡¨π‡¨æ‡¨∏ ‡¨¶‡≠á‡¨ñ‡¨®‡≠ç‡¨§‡≠Å</button>
      </div>
      <p class="muted mt-3">‡¨≤‡¨ó‡¨ø‡¨®‡≠ç ‡¨•‡¨ø‡¨¨‡¨æ staff ‡¨Æ‡¨æ‡¨§‡≠ç‡¨∞ ‡¨è‡¨π‡¨ø ‡¨¨‡¨ü‡¨®‡≠ç use ‡¨ï‡¨∞‡¨ø‡¨™‡¨æ‡¨∞‡¨ø‡¨¨‡•§</p>
    </div>
  </section>

  <!-- Boss panel (read-only placeholder) -->
  <section id="bossPanel" class="hidden p-5 max-w-3xl mx-auto">
    <div class="card">
      <h2 class="text-xl font-bold mb-3">üë®‚Äçüíº Boss Dashboard (Read-only sample)</h2>
      <p class="muted">‡¨è‡¨†‡¨æ‡¨∞‡≠á ‡¨™‡¨∞‡≠á summary/report ‡¨¶‡≠á‡¨¨‡¨æ‡¨ï‡≠Å ‡¨™‡¨æ‡¨∞‡¨ø‡¨¨‡≠Å‡•§ ‡¨è‡¨™‡¨∞‡≠ç‡¨Ø‡≠ç‡≠ü‡¨®‡≠ç‡¨§ auth ‡¨≠‡¨≤‡¨≠‡¨æ‡¨¨‡≠á ‡¨ö‡¨æ‡¨≤‡≠Å‡¨õ‡¨ø‡•§</p>
    </div>
  </section>

  <!-- History (today) -->
  <section id="history" class="hidden p-5 max-w-xl mx-auto">
    <div class="card">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold">üìú ‡¨Ü‡¨ú‡¨ø‡¨∞ ‡¨á‡¨§‡¨ø‡¨π‡¨æ‡¨∏</h2>
        <button id="btnBack" class="px-3 py-1 rounded bg-gray-700 text-white text-sm">‚¨Ö Back</button>
      </div>
      <div id="historyMeta" class="muted mt-1"></div>
      <div id="historyList" class="space-y-2 text-sm mt-3"></div>
    </div>
  </section>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Core App (non-auth) -->
  <script>
    const $ = id => document.getElementById(id);
    const appEl = $('app'), histEl = $('history'), bossEl = $('bossPanel');
    const whoami = $('whoami'), envNote = $('envNote'), toastEl = $('toast');
    const historyMeta = $('historyMeta'), historyList = $('historyList');

    function showToast(msg){ toastEl.textContent=msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',2000); }
    function nowIST(){ return new Date().toLocaleString("en-IN",{ timeZone:"Asia/Kolkata" }); }
    function todayISO(){ return new Date().toLocaleDateString("en-CA",{ timeZone:"Asia/Kolkata" }); }

    // default (patched by Firebase block)
    function saveToStorage(key,data){ localStorage.setItem(key, JSON.stringify(data)); }
    function loadFromStorage(key){ const v=localStorage.getItem(key); return v?JSON.parse(v):null; }

    // attendance actions
    function recordAttendance(action, currentUserName){
      if(!currentUserName){ showToast("Not signed in"); return; }
      const key = `attendance_${currentUserName}_${todayISO()}`;
      const day = loadFromStorage(key) || [];
      day.push({ action, time: nowIST() });
      saveToStorage(key, day);
      showToast(`${action} ‚úÖ`);
    }

    $('btnCheckIn').onclick    = () => recordAttendance("Check-In",  window._currentUserName);
    $('btnBreakStart').onclick = () => recordAttendance("Break Start",window._currentUserName);
    $('btnBreakEnd').onclick   = () => recordAttendance("Break End",  window._currentUserName);
    $('btnCheckOut').onclick   = () => recordAttendance("Check-Out",  window._currentUserName);

    $('btnHistory').onclick = () => {
      const key = `attendance_${window._currentUserName}_${todayISO()}`;
      const items = loadFromStorage(key) || [];
      historyMeta.textContent = `${window._currentUserName||'‚Äî'} ‚Ä¢ ${todayISO()}`;
      historyList.innerHTML = items.length
        ? items.map(e=>`<div>üëâ <b>${e.action}</b> ‚Äî <span class="muted">${e.time}</span></div>`).join("")
        : `<div class="muted">No entries yet today.</div>`;
      appEl.classList.add('hidden'); bossEl.classList.add('hidden'); histEl.classList.remove('hidden');
    };
    $('btnBack').onclick = ()=>{ histEl.classList.add('hidden'); appEl.classList.remove('hidden'); };
  </script>

  <!-- ‚úÖ Firebase + Firestore + Auth (with file:// fallback) -->
  <script type="module" id="firebase-block">
    /* ------- Config ------- */
    const ADMIN_EMAIL = "manojgatibbi506@gmail.com"; /* <-- ‡¨è‡¨†‡¨ø ‡¨§‡≠Å‡¨Æ Boss ‡¨ô‡≠ç‡¨ï Gmail ‡¨¶‡¨ø‡¨Ö */

    const secureOrigin = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    const USE_FIREBASE = secureOrigin;

    if(!secureOrigin){ document.getElementById('envNote').textContent = "‚ÑπÔ∏è File/content URL ‚Äî localStorage only. Host on HTTPS for Firestore."; }

    // lazy load SDKs only on secure origin
    if (USE_FIREBASE) {
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js");
      const app = initializeApp({
        apiKey: "AIzaSyAqAtKOA9eOFl6pj92HPdEBKQw5Lx7O7ws",
        authDomain: "a-to-z-attendance.firebaseapp.com",
        projectId: "a-to-z-attendance",
        storageBucket: "a-to-z-attendance.firebasestorage.app",
        messagingSenderId: "460745582900",
        appId: "1:460745582900:web:e7afc7c31f683cc0c71d61"
      });

      const { getFirestore, doc, setDoc, getDoc, serverTimestamp } =
        await import("https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js");
      const db = getFirestore(app);

      const { getAuth, onAuthStateChanged, signInWithEmailAndPassword,
              GoogleAuthProvider, signInWithPopup, signOut } =
        await import("https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js");
      const auth = getAuth(app);

      /* -------- storage helpers patched to cloud sync + userId -------- */
      (function patchStorage(){
        const _origSave = window.saveToStorage;
        const _origLoad = window.loadFromStorage;

        window.saveToStorage = async function(key, data){
          try{
            localStorage.setItem(key, JSON.stringify(data));
            // also write to Firestore
            const u = auth.currentUser || null;
            const userId = u ? u.uid : null;
            const { col, id } = keyToPath(key);
            await setDoc(doc(db, col, id), { key, data, userId, updatedAt: serverTimestamp() }, { merge: true });
          }catch(e){ console.error("saveToStorage failed:", e); }
        };

        window.loadFromStorage = function(key){
          try{
            const cached = localStorage.getItem(key);
            const parsed = cached ? JSON.parse(cached) : null;
            // background refresh
            const { col, id } = keyToPath(key);
            getDoc(doc(db, col, id)).then(snap=>{
              if(snap.exists()){
                const remote = snap.data().data ?? null;
                if(remote !== null && JSON.stringify(remote) !== JSON.stringify(parsed)){
                  localStorage.setItem(key, JSON.stringify(remote));
                  window.dispatchEvent(new CustomEvent("storageRefreshed", { detail: { key } }));
                }
              }
            }).catch(()=>{});
            return parsed;
          }catch(e){ console.error("loadFromStorage failed:", e); return null; }
        };
      })();

      function keyToPath(key){
        if(key.startsWith("attendance_")){
          const parts = key.split("_");
          const name  = (parts[1]||"unknown").replaceAll("/","_");
          const date  = (parts[2]||"unknown").replaceAll("/","_");
          return { col: "attendance", id: `${name}__${date}` };
        }
        return { col: "kv", id: key.replaceAll("/","_") };
      }

      /* -------- Auth UI handlers -------- */
      const staffBtn   = document.getElementById("btnStaffLogin");
      const bossBtn    = document.getElementById("btnBossGoogle");
      const signOutBtn = document.getElementById("btnSignOut");
      const whoami     = document.getElementById("whoami");
      const appEl      = document.getElementById("app");
      const bossEl     = document.getElementById("bossPanel");
      const histEl     = document.getElementById("history");

      staffBtn?.addEventListener("click", async ()=>{
        const email = document.getElementById("email").value.trim();
        const pass  = document.getElementById("password").value;
        try{ await signInWithEmailAndPassword(auth, email, pass); }
        catch(e){ alert("Login failed: " + e.message); }
      });

      bossBtn?.addEventListener("click", async ()=>{
        try{
          const provider = new GoogleAuthProvider();
          await signInWithPopup(auth, provider);
        }catch(e){ alert("Google sign-in failed: " + e.message); }
      });

      signOutBtn?.addEventListener("click", ()=> signOut(auth));

      /* -------- Auth state (Staff = full, Boss = read-only) -------- */
      onAuthStateChanged(auth, (user)=>{
        const whoami      = document.getElementById("whoami");
        const signOutBtn  = document.getElementById("btnSignOut");
        const appEl       = document.getElementById("app");
        const bossEl      = document.getElementById("bossPanel");
        const histEl      = document.getElementById("history");

        // Hide all panels first
        appEl?.classList.add('hidden');
        bossEl?.classList.add('hidden');
        histEl?.classList.add('hidden');

        if(!user){
          window._currentUserName = null;
          if (whoami) whoami.textContent = "Not signed in";
          signOutBtn?.classList.add("hidden");
          return;
        }

        const prov  = user.providerData[0]?.providerId || "password";
        const email = user.email || user.phoneNumber || "(no email)";
        if (whoami) whoami.textContent = `Signed in: ${email} (${prov})`;
        signOutBtn?.classList.remove("hidden");

        // Boss = Google + ADMIN_EMAIL
        const isBoss = (prov === "google.com") && (user.email === ADMIN_EMAIL);
        if (isBoss) {
          bossEl?.classList.remove('hidden');   // Boss read-only dashboard
          window._currentUserName = "Boss";
          return; // Attendance buttons hidden for boss
        }

        // Staff = Email/Password ‚Üí FULL attendance features
        const isStaff = (prov === "password");
        if (isStaff) {
          window._currentUserName = (String(email).split("@")[0] || "Staff");
          appEl?.classList.remove('hidden');    // show attendance buttons
          return;
        }

        // Others ‚Üí limited
        if (whoami) whoami.textContent += " ‚Ä¢ Limited access";
      });

      // expose for quick tests
      window._firebase = { app, db, auth, USE_FIREBASE };
    } else {
      window._firebase = { app: null, db: null, auth: null, USE_FIREBASE };
    }
  </script>

  <!-- (Optional) üîé Quick Test Button -->
  <div class="max-w-xl mx-auto p-5">
    <div class="card">
      <button id="btnFbWrite" class="btn btn-blue">Test Cloud Write/Read</button>
      <div id="fbMsg" class="mt-2 text-sm"></div>
    </div>
  </div>
  <script>
    (function(){
      const btn=document.getElementById('btnFbWrite'), msg=document.getElementById('fbMsg');
      btn?.addEventListener('click', async ()=>{
        msg.textContent='Testing‚Ä¶';
        try{
          if(!window._firebase || !window._firebase.db){ msg.style.color='#b91c1c'; msg.textContent='‚ùå SDK ‡¨≤‡≠ã‡¨°‡≠ç ‡¨π‡≠ã‡¨á‡¨®‡¨æ‡¨π‡¨ø‡¨Å'; return; }
          const m = await import("https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js");
          const { doc,setDoc,getDoc,serverTimestamp } = m;
          const { db } = window._firebase;
          const id="selftest__"+Date.now();
          const ref=doc(db,"selftest",id);
          await setDoc(ref,{ok:true,host:location.hostname,ts:serverTimestamp()});
          const snap=await getDoc(ref);
          msg.style.color='#065f46';
          msg.textContent='‚úÖ Firestore OK: '+JSON.stringify(snap.data());
        }catch(e){ msg.style.color='#b91c1c'; msg.textContent='‚ùå '+(e.message||e); }
      });
    })();
  </script>

</body>
</html>